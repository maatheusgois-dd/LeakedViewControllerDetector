name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DEVELOPER_DIR: /Applications/Xcode_16.1.app/Contents/Developer

jobs:
  test:
    name: Test with xcodebuild
    runs-on: macos-15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.1'
    
    - name: Run tests with xcodebuild
      run: xcodebuild -scheme LeakedViewControllerDetector -destination 'platform=iOS Simulator,name=iPhone 16 Pro,OS=18.0' test

  lint:
    name: SwiftLint
    runs-on: macos-15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install SwiftLint
      run: brew install swiftlint
    
    - name: Run SwiftLint
      run: swiftlint lint --reporter github-actions-logging

  swiftformat:
    name: SwiftFormat
    runs-on: macos-15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.1'
    
    - name: Install SwiftFormat
      run: |
        brew install swiftformat
    
    - name: Check Swift formatting
      run: |
        echo "Checking Swift formatting with SwiftFormat..."
        swiftformat --lint Sources/ Tests/
    
    - name: Format Swift code (dry run)
      run: |
        echo "Running SwiftFormat dry run to check for changes..."
        swiftformat --dryrun --verbose Sources/ Tests/
    
    - name: Check for formatting changes
      run: |
        # Run SwiftFormat and capture output
        if ! swiftformat --dryrun Sources/ Tests/ > /dev/null 2>&1; then
          echo "❌ Code formatting issues found. Please run 'swiftformat Sources/ Tests/' locally."
          echo "Or use the format script: ./scripts/format.sh"
          swiftformat --dryrun --verbose Sources/ Tests/
          exit 1
        else
          echo "✅ Code is properly formatted."
        fi

  package-validation:
    name: Package Validation
    runs-on: macos-15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.1'
    
    - name: Validate Package.swift
      run: swift package dump-package > /dev/null
    
    - name: Check package dependencies
      run: swift package show-dependencies
    
    - name: Resolve package dependencies
      run: swift package resolve
    
    - name: Build for release
      run: swift build -c release

  documentation:
    name: Documentation Build
    runs-on: macos-15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.1'
    
    - name: Install DocC
      run: |
        swift package resolve
        swift build

  integration-test:
    name: Integration Tests
    runs-on: macos-15
    needs: [test, lint, package-validation]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.1'
    
    - name: Create test app
      run: |
        mkdir -p TestApp
        cd TestApp
        cat > Package.swift << 'EOF'
        // swift-tools-version:6.0
        import PackageDescription
        
        let package = Package(
            name: "TestApp",
            platforms: [.iOS(.v13)],
            dependencies: [
                .package(path: "../")
            ],
            targets: [
                .executableTarget(
                    name: "TestApp",
                    dependencies: ["LeakedViewControllerDetector"]
                )
            ]
        )
        EOF
        
        mkdir -p Sources/TestApp
        cat > Sources/TestApp/main.swift << 'EOF'
        import Foundation
        import LeakedViewControllerDetector
        
        print("Integration test: LeakedViewControllerDetector imported successfully")
        EOF
    
    - name: Build integration test
      run: |
        cd TestApp
        swift build
    
    - name: Run integration test
      run: |
        cd TestApp
        swift run TestApp 